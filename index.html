<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Neon Runner TWA</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script src='//libtl.com/sdk.js' data-zone='10416947' data-sdk='show_10416947'></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        body { 
            margin: 0; overflow: hidden; background: #000; 
            font-family: 'Segoe UI', sans-serif;
            touch-action: none; user-select: none; color: white;
        }

        /* UI লেআউট */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; 
            justify-content: center; align-items: center;
            background: rgba(0, 0, 0, 0.95);
            z-index: 100;
            transition: opacity 0.3s;
        }

        .hidden { display: none !important; }

        /* হোম স্ক্রিন */
        h1 {
            color: #00ff88; text-transform: uppercase; 
            font-size: 40px; text-shadow: 0 0 20px #00ff88; margin-bottom: 10px;
        }
        
        /* বাটন স্টাইল */
        .btn-primary {
            background: linear-gradient(45deg, #00ff88, #00cc6a);
            color: #000; border: none; padding: 15px 40px; 
            font-size: 22px; font-weight: bold; cursor: pointer; 
            border-radius: 50px; text-transform: uppercase;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
            margin-top: 20px;
        }
        .btn-primary:active { transform: scale(0.95); }

        /* গেম ওভার স্ক্রিন */
        #game-over-screen { z-index: 200; border: 2px solid #ff4444; background: rgba(0,0,0,0.9); }
        .score-text { font-size: 24px; margin-bottom: 20px; }
        .ad-status { color: #aaaaaa; font-size: 14px; margin-top: 10px; }

        /* ইন-গেম স্কোর */
        #hud {
            position: absolute; top: 0; left: 0; width: 100%; padding: 20px;
            pointer-events: none; z-index: 50;
            font-size: 24px; font-weight: bold; color: #00ff88;
        }
    </style>
</head>
<body>

    <div id="home-screen" class="screen">
        <h1>Neon Run</h1>
        <p>Telegram Endless Runner</p>
        <button class="btn-primary" onclick="firstStart()">PLAY NOW</button>
    </div>

    <div id="hud" class="hidden">SCORE: <span id="score">0</span></div>

    <div id="game-over-screen" class="screen hidden">
        <h1 style="color: #ff4444; text-shadow: 0 0 20px #ff0000;">CRASHED!</h1>
        <div class="score-text">Score: <span id="final-score">0</span></div>
        
        <button id="ad-btn" class="btn-primary" onclick="handleAdWatch()">
            Watch Ad (1/3)
        </button>
        <p class="ad-status">Watch 3 ads to revive!</p>
    </div>

    <script>
        // --- Telegram Setup ---
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand(); // গেম ফুলস্ক্রিন করার জন্য

        // --- Game Config ---
        const GAME_SPEED = 0.6; 
        const SPAWN_RATE = 1000;

        // Variables
        let scene, camera, renderer, player;
        let obstacles = [];
        let score = 0;
        let isGameRunning = false;
        let isGameOver = false;
        let obstacleTimeout;
        
        // Ad Logic Variables
        let adsWatchedCount = 0;
        const ADS_REQUIRED = 3;

        // Player Controls
        let currentLane = 0; 
        const laneWidth = 3;
        let isJumping = false;
        let jumpVelocity = 0;
        const gravity = 0.03;
        let touchStartX = 0, touchStartY = 0;

        // --- UI Functions ---

        function firstStart() {
            document.getElementById('home-screen').classList.add('hidden');
            document.getElementById('hud').classList.remove('hidden');
            
            // প্রথমবার সিন ইনিশিয়ালাইজ এবং স্টার্ট
            if (!renderer) {
                initGameScene();
            }
            startGame();
        }

        // অ্যাড লজিক হ্যান্ডলার (সবচেয়ে গুরুত্বপূর্ণ অংশ)
        function handleAdWatch() {
            // Monetag এর ফাংশন কল করা হচ্ছে
            if (typeof show_10416947 === 'function') {
                show_10416947().then(() => {
                    // অ্যাড সাকসেসফুলি কল হলে (নোট: সব অ্যাড নেটওয়ার্ক Promise রিটার্ন করে না, তবে সেফ থাকার জন্য ট্রাই করা)
                    console.log('Ad called');
                }).catch(e => {
                    console.log('Ad script blocker or error', e);
                });
            } else {
                alert("Ad script not loaded yet! Please check internet connection.");
                // টেস্ট করার জন্য (অ্যাডব্লকার থাকলে যাতে আটকে না থাকেন)
                // বাস্তব অ্যাপে নিচের লাইন মুছে দিতে পারেন যদি কড়াকড়ি চান
                // processAdStep(); 
                // return;
            }

            // যেহেতু আমরা নিশ্চিত হতে পারি না ইউজার অ্যাড পুরো দেখেছে কিনা (Script limitations),
            // আমরা ধরে নেব ইউজার ক্লিক করলেই ১টি কাউন্ট হবে।
            // Monetag সাধারণত পপ-আন্ডার বা ইন্টারস্টিশিয়াল ওপেন করে।
            
            processAdStep();
        }

        function processAdStep() {
            adsWatchedCount++;
            const btn = document.getElementById('ad-btn');

            if (adsWatchedCount < ADS_REQUIRED) {
                // বাটন টেক্সট আপডেট
                btn.innerText = `Watch Ad (${adsWatchedCount + 1}/${ADS_REQUIRED})`;
                btn.style.background = "linear-gradient(45deg, #ffaa00, #ff8800)"; // কালার চেঞ্জ
            } else {
                // ৩টা দেখা শেষ
                btn.innerText = "STARTING...";
                setTimeout(() => {
                    restartGame();
                }, 500);
            }
        }

        function startGame() {
            isGameRunning = true;
            isGameOver = false;
            score = 0;
            currentLane = 0;
            document.getElementById('score').innerText = '0';
            
            // রিসেট প্লেয়ার
            player.position.set(0, 0.5, 0);
            player.rotation.set(0, 0, 0);
            
            animate();
            spawnObstacleLoop();
        }

        function gameOver() {
            isGameOver = true;
            isGameRunning = false;
            clearTimeout(obstacleTimeout);
            
            document.getElementById('final-score').innerText = score;
            document.getElementById('hud').classList.add('hidden');
            document.getElementById('game-over-screen').classList.remove('hidden');

            // অ্যাড কাউন্টার রিসেট
            adsWatchedCount = 0;
            const btn = document.getElementById('ad-btn');
            btn.innerText = `Watch Ad (1/${ADS_REQUIRED})`;
            btn.style.background = "linear-gradient(45deg, #00ff88, #00cc6a)";
        }

        function restartGame() {
            // ক্লিন সিন
            obstacles.forEach(ob => scene.remove(ob));
            obstacles = [];
            
            document.getElementById('game-over-screen').classList.add('hidden');
            document.getElementById('hud').classList.remove('hidden');
            
            startGame();
        }

        // --- 3D Game Logic ---

        function initGameScene() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x101010);
            scene.fog = new THREE.Fog(0x101010, 20, 60);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.set(0, 4, 8);
            camera.lookAt(0, 0, -8);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // Lighting
            scene.add(new THREE.AmbientLight(0xffffff, 0.8));
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.5);
            dirLight.position.set(0, 10, 5);
            scene.add(dirLight);

            // Floor
            const grid = new THREE.GridHelper(200, 50, 0x00ff88, 0x222222);
            grid.position.z = -50;
            scene.add(grid);

            // Player
            player = new THREE.Mesh(
                new THREE.BoxGeometry(1, 1, 1),
                new THREE.MeshLambertMaterial({ color: 0x00ff88 })
            );
            player.position.y = 0.5;
            scene.add(player);

            // Inputs
            setupInputs();
        }

        function setupInputs() {
            document.addEventListener('keydown', e => {
                if(!isGameRunning) return;
                if(e.key === 'ArrowLeft' && currentLane > -1) currentLane--;
                if(e.key === 'ArrowRight' && currentLane < 1) currentLane++;
                if((e.key === 'ArrowUp' || e.code === 'Space') && !isJumping) {
                    isJumping = true; jumpVelocity = 0.6;
                }
            });

            document.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            });

            document.addEventListener('touchend', e => {
                if(!isGameRunning) return;
                let dx = e.changedTouches[0].screenX - touchStartX;
                let dy = e.changedTouches[0].screenY - touchStartY;
                if(Math.abs(dx) > Math.abs(dy)) {
                    if(dx > 30 && currentLane < 1) currentLane++;
                    if(dx < -30 && currentLane > -1) currentLane--;
                } else if(dy < -30 && !isJumping) {
                    isJumping = true; jumpVelocity = 0.6;
                }
            });
            
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        function spawnObstacle() {
            if(!isGameRunning) return;
            const ob = new THREE.Mesh(
                new THREE.BoxGeometry(1.2, 1.2, 1.2),
                new THREE.MeshLambertMaterial({ color: 0xff0044 })
            );
            ob.position.set((Math.floor(Math.random()*3)-1)*laneWidth, 0.6, -100);
            scene.add(ob);
            obstacles.push(ob);
        }

        function spawnObstacleLoop() {
            if(!isGameRunning) return;
            spawnObstacle();
            obstacleTimeout = setTimeout(spawnObstacleLoop, SPAWN_RATE);
        }

        function animate() {
            if (!isGameRunning) return;

            // Player Logic
            player.position.x += (currentLane * laneWidth - player.position.x) * 0.2;
            if (isJumping) {
                player.position.y += jumpVelocity;
                jumpVelocity -= gravity;
                if (player.position.y <= 0.5) {
                    player.position.y = 0.5; isJumping = false;
                }
            }

            // Obstacle Logic
            for (let i = obstacles.length - 1; i >= 0; i--) {
                let ob = obstacles[i];
                ob.position.z += GAME_SPEED;

                // Collision
                if (ob.position.z > -1 && ob.position.z < 1) {
                    if (Math.abs(ob.position.x - player.position.x) < 1 && player.position.y < 1) {
                        gameOver();
                        return;
                    }
                }
                // Cleanup
                if (ob.position.z > 5) {
                    scene.remove(ob);
                    obstacles.splice(i, 1);
                    score++;
                    document.getElementById('score').innerText = score;
                }
            }

            renderer.render(scene, camera);
            requestAnimationFrame(animate);
        }
    </script>
</body>
    </html>
